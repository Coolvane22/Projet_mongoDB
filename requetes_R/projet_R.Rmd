---
title: "Projet MongoDB"
author: "GOUTARD Amélie & THIVEND Evane"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Librairies
```{r}
lib <- c("tidyverse", "mongolite", "rlist")
sapply(lib, require, character = TRUE)

```

# Connexion à la base de données
```{r}

mdb = mongo(
  collection = "hal_irisa_2021",
  url = "mongodb+srv://etudiant:ur2@clusterm1.0rm7t.mongodb.net/publications",
  verbose = TRUE
)

```


# Récupération des données nécessaires pour la visualisation  
Votre requête MongoDB devra récupérer pour chacun de ces auteurs la liste de ses publications (la suite du traitement qui consiste à calculer le nombre d’articles commun par paire d’auteurs pourra être réalisée dans votre script).  
```{r}
req <- '[
  {"$unwind" : "$authors"},
  {"$sort" : {"_id" : 1} } 
]'

data <- mdb$aggregate(pipeline = req)


## on garde uniquement les 20 auteurs qui ont participe a l'ecriture du plus grand nombre d'articles
req <- '[
  {"$unwind" : "$authors"},
  {"$group" : {"_id" : "$authors", "nb": {"$sum" : 1} } },
  {"$sort" : {"nb" : -1} },
  {"$limit" : 20}
]'

top20_authors <- mdb$aggregate(pipeline = req)

# on stocke dans un tibble avec une structure plus claire (une colonne pour name et firstname)
top20_authors_final <- tibble(
  name = top20_authors$"_id"$name,
  firstname = top20_authors$"_id"$firstname,
  nb = top20_authors$nb
) %>% 
  # on initialise une colonne publications qui pour chaque auteur correspond au vecteurs des articles auquel il a participe
  mutate(publications = "title")

## on recupere pour chacun des 20 auteurs la liste de ses publications 
i <- 1
data_final <- tibble()
while(i <= nrow(top20_authors_final) ){
  q <- mdb$find(
    query = paste0(
      ' {"authors" : {"$elemMatch" : {"name" : "', pull(top20_authors_final[i,"name"]), '", 
                      "firstname" : "', pull(top20_authors_final[i,"firstname"]),'"} } 
      } ' 
    ),
    fields = '{"_id" : true} '
    )
  transition <- tibble(
    name = pull(top20_authors_final[i,"name"]),
    firstname = pull(top20_authors_final[i,"firstname"]),
    publications = q$"_id"
  )
  data_final <- rbind(data_final, transition)
  i <- i + 1
}

## on calcule le nombre d'articles commun par paire d'auteurs (en R)
# on ajoute une colonne qui contient le nom et prenom de chaque auteur
data_final <- data_final %>% 
  mutate("nom_prenom" = paste(name, firstname, sep = " "))

# on etablit le tableau de contingence
mm <- data_final %>% 
  group_by(publications) %>% 
  summarise(n = n())


```
Exemple de bonus : Vous pourrez faire en sorte que l’épaisseur des traits joignant les auteurs soit proportionnelle au nombre de publications communes.


# Visualisation
```{r}

```

